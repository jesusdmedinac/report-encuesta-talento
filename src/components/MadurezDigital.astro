---
import type { ScaleDecile, NivelMadurez } from "../utils/utils";
import { ClassByLevel, scoreToScaleDecile } from "../utils/utils";

const {
    titulo = "Madurez Digital",
    puntuacionGeneral = 2.1,
    puntuacionPromedioSector = 1.7,
    nombreEmpresa = "",
    parrafoIntroductorio = "Profermaco se encuentra en la primera etapa de madurez digital (2.1/10), con una excelente oportunidad de crecimiento de 1.65 puntos hacia la meta del sector (3.75/10). Este indicador refleja un potencial extraordinario para desarrollar la capacidad organizacional de aprovechar tecnologías digitales de manera estratégica en el sector ferretero y de materiales de construcción.",
    componentes = [
        {
            nombre: "Capacidad para aprender nuevas tecnologías",
            puntuacion: 2.1,
            descripcion: "El equipo de Profermaco está en la primera etapa de desarrollo de habilidades tecnológicas. Existe una excelente oportunidad para implementar programas de capacitación específicos para el sector ferretero que fortalezcan la adaptación a nuevas herramientas digitales.",
            color: "var(--color-company)",
            colorGradiente: "#4387ff",
            meta: 3.75
        },
        {
            nombre: "Actitud frente a nuevas tecnologías",
            puntuacion: 2.1,
            descripcion: "El equipo muestra una actitud receptiva hacia las nuevas tecnologías, estableciendo una base sólida para el crecimiento. Con el apoyo adecuado y programas de capacitación bien estructurados, esta actitud positiva puede transformarse en competencias digitales avanzadas aplicadas al sector ferretero y de materiales de construcción.",
            color: "var(--color-gap)",
            colorGradiente: "#a78bfa",
            meta: 7.5
        }
    ]
} = Astro.props;

const scaleDecile = scoreToScaleDecile(puntuacionGeneral, "madurezDigital") as ScaleDecile;
const percentil = scaleDecile?.puntaje;
const nivel = scaleDecile?.nivel as NivelMadurez;
const medidaStyle = `width: ${percentil}%; left: 0;`;
const percentilPromedioSector = scoreToScaleDecile(puntuacionPromedioSector, "madurezDigital")?.puntaje || 0;
const promedioStyle = `left: ${percentilPromedioSector}%;`;
const componentsWithPercentile = componentes.map((componente: any) => ({
    ...componente,
    scaleDecile: scoreToScaleDecile(componente.puntuacion, "madurezDigital") as ScaleDecile
}));
---
<style>
  .badge { border-radius: 999px; }
  .lvl-low { padding: 0.12rem 0.5rem; background: #fee2e2; color: #7f1d1d; }
  .lvl-mid { padding: 0.12rem 0.5rem; background: #fef3c7; color: #78350f; }
  .lvl-high { padding: 0.12rem 0.5rem; background: #dcfce7; color: #14532d; }
</style>
<section>
    <h2>{titulo}</h2>
    <p><strong>Nivel actual de {nombreEmpresa}:</strong> <span>Percentil {percentil}</span> <span class:list={[ClassByLevel[nivel], "badge"]}>{nivel}</span></p>
    
    <div class="bullet-graph">  
      <div class="bullet-title">
        <span>Nivel de Madurez Digital</span>
      </div>
        <div class="bullet-container">
            <div class="bullet-range bullet-range-poor lvl-low"></div>
            <div class="bullet-range bullet-range-fair lvl-mid"></div>
            <div class="bullet-range bullet-range-good lvl-high"></div>
            <div class="bullet-measure" style={medidaStyle}></div>
            <div class="bullet-average" style={promedioStyle}></div>
        </div>
        <div class="bullet-legend">
            <div class="bullet-item">
                <div class="legend-color lvl-low"></div>
                <span>Inicial (0-20)</span>
            </div>
            <div class="bullet-item">
                <div class="legend-color lvl-mid"></div>
                <span>En desarrollo (20-80)</span>
            </div>
            <div class="bullet-item">
                <div class="legend-color lvl-high"></div>
                <span>Avanzado (80-100)</span>
            </div>
            <div class="bullet-item">
                <div class="legend-color" style="background-color: var(--color-company);"></div>
                <span>{nombreEmpresa}</span>
            </div>
            <div class="bullet-item">
                <div class="legend-color" style="background-color: var(--color-average); width: 2px; height: 15px;"></div>
                <span>Promedio sector ({puntuacionPromedioSector})</span>
            </div>
        </div>
    </div>
    <p>{parrafoIntroductorio}</p>
    
    <h4 style="margin-top: 30px; color: var(--primary); font-size: 1.15rem;">Componentes de la Madurez Digital</h4>
    
    <div style="display: grid; grid-template-columns: 1fr; gap: 25px; margin: 20px 0 30px;">
        {componentsWithPercentile.map((componente: {nombre: string, puntuacion: number, color: string, colorGradiente: string, meta: number, descripcion: string, scaleDecile?: {nivel: NivelMadurez, puntaje: number}}) => (
            <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-weight: 600; font-size: 1rem;">{componente.nombre}</span>
                    <span class:list={[ClassByLevel[componente.scaleDecile?.nivel || "Inicial"]]}>Percentil {componente.scaleDecile?.puntaje}</span>
                </div>
                <div style="position: relative; height: 16px; background: #f0f0f0; border-radius: 8px; overflow: hidden; margin-bottom: 8px;">
                    <div style={`position: absolute; height: 100%; width: ${(componente.scaleDecile?.puntaje || 0)}%; background: linear-gradient(to right, ${componente.color}, ${componente.colorGradiente}); border-radius: 8px 0 0 8px;`}></div>
                    <div style={`position: absolute; height: 24px; width: 2px; background: var(--color-target); top: -4px; left: ${componente.meta * 10}%; box-shadow: 0 0 5px rgba(17, 24, 39, 0.3);`}></div>
                </div>
                <p style="margin-top: 15px; font-size: 0.95rem; color: var(--text-secondary);">{componente.descripcion}</p>
            </div>
        ))}
    </div>
</section>
